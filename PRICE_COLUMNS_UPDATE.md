# تحديث أعمدة الأسعار في جدول الطلبات

## ملخص التغييرات

تم تحديث النظام لحفظ أعمدة الأسعار (`price`, `shipping_cost`, `total_amount`) في جدول الطلبات مباشرةً، مما يجعل جميع العمليات اللاحقة (Google Sheets، ZR Express) تعتمد على القيم المحفوظة فقط.

## الأعمدة المضافة

| العمود           | النوع      | الوصف                                 | القيمة الافتراضية |
|------------------|------------|---------------------------------------|-------------------|
| price            | numeric    | سعر المنتج الواحد                      | 0                 |
| shipping_cost    | numeric    | تكلفة التوصيل                         | 0                 |
| total_amount     | numeric    | المجموع النهائي للطلب                 | 0                 |

## خطوات التنفيذ

### 1. تحديث قاعدة البيانات

قم بتنفيذ السكريبت التالي في Supabase SQL Editor:

```sql
-- إضافة أعمدة الأسعار إلى جدول الطلبات
ALTER TABLE orders ADD COLUMN IF NOT EXISTS price numeric DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS shipping_cost numeric DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS total_amount numeric DEFAULT 0;
```

### 2. التعديلات البرمجية المنجزة

#### أ. API حفظ الطلبات (`app/api/orders/route.ts`)
- ✅ إضافة حساب تكلفة التوصيل باستخدام `calculateShippingCost`
- ✅ حساب السعر الإجمالي للمنتج
- ✅ حساب المجموع النهائي
- ✅ حفظ جميع القيم في قاعدة البيانات

#### ب. API Google Sheets (`app/api/sheets/route.ts`)
- ✅ استخدام القيم المحفوظة بدلاً من إعادة الحساب
- ✅ جلب `price`, `shipping_cost`, `total_amount` من جدول الطلبات

#### ج. API ZR Express (`app/api/zr-express/create-order/route.ts`)
- ✅ جلب بيانات الطلب من قاعدة البيانات
- ✅ استخدام القيم المحفوظة إذا كانت متوفرة
- ✅ الرجوع للقيم المرسلة كبديل

#### د. صفحة الإدارة (`app/admin/page.tsx`)
- ✅ إرسال معرف الطلب مع البيانات
- ✅ استخدام القيم المحفوظة في جدول الطلبات

#### ه. نوع البيانات (`lib/supabase.ts`)
- ✅ تحديث واجهة `Order` لجعل أعمدة الأسعار مطلوبة
- ✅ تحديث دوال إنشاء الطلبات للتأكد من وجود القيم

## طريقة الحساب

### تكلفة التوصيل
```typescript
const shippingCost = calculateShippingCost(wilaya, deliveryType, quantity)
```

### السعر الإجمالي للمنتج
```typescript
const productTotal = productPrice * quantity
```

### المجموع النهائي
```typescript
const totalAmount = productTotal + shippingCost
```

## المزايا

1. **دقة البيانات**: جميع العمليات تستخدم نفس القيم المحفوظة
2. **السرعة**: لا حاجة لإعادة الحساب في كل مرة
3. **التتبع**: يمكن تتبع الأسعار التاريخية
4. **المرونة**: سهولة التعديل على الأسعار لاحقاً

## الاختبار

بعد تطبيق التغييرات، تأكد من:

1. ✅ إنشاء طلب جديد وحفظه في قاعدة البيانات
2. ✅ التحقق من وجود أعمدة الأسعار في جدول الطلبات
3. ✅ إرسال الطلب إلى Google Sheets
4. ✅ إرسال الطلب إلى ZR Express من صفحة الإدارة
5. ✅ التحقق من صحة القيم في جميع العمليات

## ملاحظات مهمة

- الطلبات القديمة ستحتوي على قيم افتراضية (0) للأعمدة الجديدة
- يمكن تحديث الطلبات القديمة يدوياً إذا لزم الأمر
- النظام سيعمل بشكل طبيعي مع الطلبات الجديدة 