// ุฅุนุฏุงุฏ ZR Express API
const ZR_EXPRESS_CONFIG = {
  baseUrl: "https://procolis.com/api_v1",
  token: process.env.ZR_EXPRESS_TOKEN || "a16ca0a3cefb4a9c728886f8572cd524d30569b67f3141ec722e600995c07a54",
  key: process.env.ZR_EXPRESS_KEY || "3adcb49b5f0147aaa68d84bfac7b8bb0",
}

// ุฃุณุนุงุฑ ุงูุชูุตูู ุงูุญููููุฉ ูู ZR Express
const SHIPPING_RATES = {
  ุฃุฏุฑุงุฑ: { home: 1400, office: 900 },
  ุงูุดูู: { home: 850, office: 450 },
  ุงูุฃุบูุงุท: { home: 950, office: 550 },
  "ุฃู ุงูุจูุงูู": { home: 850, office: 450 },
  ุจุงุชูุฉ: { home: 900, office: 450 },
  ุจุฌุงูุฉ: { home: 800, office: 450 },
  ุจุณูุฑุฉ: { home: 950, office: 550 },
  ุจุดุงุฑ: { home: 1100, office: 650 },
  ุงูุจููุฏุฉ: { home: 600, office: 400 },
  ุงูุจููุฑุฉ: { home: 700, office: 450 },
  ุชููุฑุงุณุช: { home: 1600, office: 1050 },
  ุชุจุณุฉ: { home: 900, office: 450 },
  ุชููุณุงู: { home: 900, office: 500 },
  ุชูุงุฑุช: { home: 850, office: 450 },
  "ุชูุฒู ูุฒู": { home: 750, office: 450 },
  ุงูุฌุฒุงุฆุฑ: { home: 500, office: 400 },
  ุงูุฌููุฉ: { home: 950, office: 500 },
  ุฌูุฌู: { home: 900, office: 450 },
  ุณุทูู: { home: 800, office: 450 },
  ุณุนูุฏุฉ: { home: 900, office: 450 },
  ุณูููุฏุฉ: { home: 900, office: 450 },
  "ุณูุฏู ุจูุนุจุงุณ": { home: 900, office: 450 },
  ุนูุงุจุฉ: { home: 850, office: 450 },
  ูุงููุฉ: { home: 900, office: 450 },
  ูุณูุทููุฉ: { home: 800, office: 450 },
  ุงููุฏูุฉ: { home: 800, office: 450 },
  ูุณุชุบุงูู: { home: 900, office: 450 },
  ุงููุณููุฉ: { home: 850, office: 500 },
  ูุนุณูุฑ: { home: 900, office: 450 },
  ูุฑููุฉ: { home: 950, office: 600 },
  ููุฑุงู: { home: 800, office: 450 },
  ุงูุจูุถ: { home: 1100, office: 600 },
  "ุจุฑุฌ ุจูุนุฑูุฑูุฌ": { home: 800, office: 450 },
  ุจููุฑุฏุงุณ: { home: 700, office: 450 },
  ุงูุทุงุฑู: { home: 850, office: 450 },
  ุชูุณูุณููุช: { home: 900, office: 450 },
  ุงููุงุฏู: { home: 950, office: 600 },
  ุฎูุดูุฉ: { home: 900, office: 450 },
  "ุณูู ุฃูุฑุงุณ": { home: 900, office: 450 },
  ุชูุจุงุฒุฉ: { home: 700, office: 450 },
  ูููุฉ: { home: 900, office: 450 },
  "ุนูู ุงูุฏููู": { home: 900, office: 450 },
  ุงููุนุงูุฉ: { home: 1100, office: 600 },
  "ุนูู ุชููุดูุช": { home: 900, office: 450 },
  ุบุฑุฏุงูุฉ: { home: 950, office: 550 },
  ุบููุฒุงู: { home: 900, office: 450 },
  ุงููุบูุฑ: { home: 950, office: 450 },
  ุงููููุนุฉ: { home: 1000, office: 500 },
  "ุฃููุงุฏ ุฌูุงู": { home: 950, office: 550 },
  "ุจูู ุนุจุงุณ": { home: 1000, office: 500 },
  ุชูููููู: { home: 1400, office: 700 },
  ุชููุฑุช: { home: 950, office: 600 },
  "ุนูู ุตุงูุญ": { home: 1600, office: 800 },
  "ุนูู ูุฒุงู": { home: 1600, office: 800 },
}

// ุฎุฑูุทุฉ ุงูููุงูุงุช ูุน ุฃุฑูุงููุง ูู ZR Express
const WILAYA_IDS: Record<string, string> = {
  "ุฃุฏุฑุงุฑ": "1",
  "ุงูุดูู": "2", 
  "ุงูุฃุบูุงุท": "3",
  "ุฃู ุงูุจูุงูู": "4",
  "ุจุงุชูุฉ": "5",
  "ุจุฌุงูุฉ": "6",
  "ุจุณูุฑุฉ": "7",
  "ุจุดุงุฑ": "8",
  "ุงูุจููุฏุฉ": "9",
  "ุงูุจููุฑุฉ": "10",
  "ุชููุฑุงุณุช": "11",
  "ุชุจุณุฉ": "12",
  "ุชููุณุงู": "13",
  "ุชูุงุฑุช": "14",
  "ุชูุฒู ูุฒู": "15",
  "ุงูุฌุฒุงุฆุฑ": "16",
  "ุงูุฌููุฉ": "17",
  "ุฌูุฌู": "18",
  "ุณุทูู": "19",
  "ุณุนูุฏุฉ": "20",
  "ุณูููุฏุฉ": "21",
  "ุณูุฏู ุจูุนุจุงุณ": "22",
  "ุนูุงุจุฉ": "23",
  "ูุงููุฉ": "24",
  "ูุณูุทููุฉ": "25",
  "ุงููุฏูุฉ": "26",
  "ูุณุชุบุงูู": "27",
  "ุงููุณููุฉ": "28",
  "ูุนุณูุฑ": "29",
  "ูุฑููุฉ": "30",
  "ููุฑุงู": "31",
  "ุงูุจูุถ": "32",
  "ุจุฑุฌ ุจูุนุฑูุฑูุฌ": "33",
  "ุจููุฑุฏุงุณ": "34",
  "ุงูุทุงุฑู": "35",
  "ุชูุณูุณููุช": "36",
  "ุงููุงุฏู": "37",
  "ุฎูุดูุฉ": "38",
  "ุณูู ุฃูุฑุงุณ": "39",
  "ุชูุจุงุฒุฉ": "40",
  "ูููุฉ": "41",
  "ุนูู ุงูุฏููู": "42",
  "ุงููุนุงูุฉ": "43",
  "ุนูู ุชููุดูุช": "44",
  "ุบุฑุฏุงูุฉ": "45",
  "ุบููุฒุงู": "46",
  "ุงููุบูุฑ": "47",
  "ุงููููุนุฉ": "48",
  "ุฃููุงุฏ ุฌูุงู": "49",
  "ุจูู ุนุจุงุณ": "50",
  "ุชูููููู": "51",
  "ุชููุฑุช": "52",
  "ุนูู ุตุงูุญ": "53",
  "ุนูู ูุฒุงู": "54",
}

// ุฏุงูุฉ ูุชุทุจูุน ุงุณู ุงูููุงูุฉ
function normalizeWilaya(wilaya: string) {
  return wilaya
    .trim()
    .replace(/\s+/g, ' ')
    .replace(/[ุฃุฅุข]/g, 'ุง')
    .replace(/ู/g, 'ู')
    .replace(/ุฉ/g, 'ู');
}

// ุฏุงูุฉ ูุชุทุจูุน ุงุณู ุงูุจูุฏูุฉ
function normalizeCommune(commune: string) {
  return commune
    .trim()
    .replace(/[ุฃุฅุข]/g, 'ุง')
    .replace(/ู/g, 'ู')
    .replace(/ุฉ/g, 'ู')
    .replace(/[ูููููููู]/g, '') // ุฅุฒุงูุฉ ุงูุชุดููู
    .replace(/\s+/g, ' ');
}

// ุฏุงูุฉ ูุญุณุงุจ ุณุนุฑ ุงูุชูุตูู
export function calculateShippingCost(wilaya: string, deliveryType: "office" | "home", quantity = 1) {
  const rates = SHIPPING_RATES[wilaya as keyof typeof SHIPPING_RATES]
  if (!rates) {
    return deliveryType === "home" ? 800 : 450
  }

  let cost = rates[deliveryType]
  if (quantity > 1) {
    cost += (quantity - 1) * 50
  }

  return cost
}

// ุฏุงูุฉ ููุญุตูู ุนูู ุฌููุน ุงูููุงูุงุช ุงููุชุงุญุฉ
export function getAvailableWilayas() {
  return Object.keys(SHIPPING_RATES)
}

// ุฏุงูุฉ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
export async function testZRExpressConnection() {
  try {
    const response = await fetch(`${ZR_EXPRESS_CONFIG.baseUrl}/token`, {
      method: "GET",
      headers: {
        token: ZR_EXPRESS_CONFIG.token,
        key: ZR_EXPRESS_CONFIG.key,
        "Content-Type": "application/json",
        Accept: "application/json",
      },
    })

    const data = await response.json()
    return {
      success: response.ok,
      data,
      status: response.status,
    }
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : "Unknown error",
      status: 0,
    }
  }
}

// ุฏุงูุฉ ุฅูุดุงุก ุงูุทูุจ ุงูุญูููู ูู ZR Express
export async function createZRExpressOrder(orderData: {
  customerName: string
  customerPhone: string
  wilaya: string
  commune: string
  address: string
  products: Array<{
    name: string
    quantity: number
    price: number
    size?: string
  }>
  totalAmount: number
  shippingCost: number
  deliveryType: "home" | "office"
}) {
  // ุชุทุจูุน ุงุณู ุงูููุงูุฉ ููุจุญุซ ูู ุงูุฎุฑูุทุฉ
  const normalizedWilaya = normalizeWilaya(orderData.wilaya);
  const wilayaId = WILAYA_IDS[normalizedWilaya] || WILAYA_IDS[orderData.wilaya] || "16";
  const trackingNumber = `NW${Date.now()}`;
  const productsDescription = orderData.products.map((p) => `${p.name}${p.size ? ` (${p.size})` : ''} x${p.quantity}`).join(" + ");

  // ูุนุงูุฌุฉ ุงูุจูุฏูุฉ - ููุท ููุชูุตูู ููููุฒู
  let communeField = "";
  if (orderData.deliveryType === "home" && orderData.commune && orderData.commune.trim() !== "") {
    communeField = normalizeCommune(orderData.commune);
  } else if (orderData.deliveryType === "home") {
    // ุฅุฐุง ูุงู ุงูุชูุตูู ููููุฒู ูููู ูุง ุชูุฌุฏ ุจูุฏูุฉุ ุงุณุชุฎุฏู ุงูููุงูุฉ
    communeField = normalizeWilaya(orderData.wilaya) || "";
  }

  const payload = {
    Colis: [
      {
        Tracking: trackingNumber,
        TypeLivraison: orderData.deliveryType === "home" ? "0" : "1",
        TypeColis: "0",
        Confrimee: "1",
        Client: orderData.customerName.trim(),
        MobileA: orderData.customerPhone.replace(/\s/g, ""),
        MobileB: "",
        Adresse: orderData.address.trim(),
        IDWilaya: wilayaId,
        Commune: communeField,
        Total: orderData.totalAmount.toString(),
        Note: "",
        TProduit: productsDescription,
        id_Externe: trackingNumber,
        Source: "NextWearDZ",
      },
    ],
  };

  console.log("๐ฆ ุฅุฑุณุงู ุทูุจ ุฅูู ZR Express:", {
    wilaya: orderData.wilaya,
    normalizedWilaya,
    wilayaId,
    deliveryType: orderData.deliveryType,
    commune: orderData.commune,
    communeField,
    trackingNumber,
    productsCount: orderData.products.length,
  });
  
  console.log("๐ ุชูุงุตูู ุฅุถุงููุฉ:", {
    originalWilaya: orderData.wilaya,
    normalizedWilaya,
    availableWilayas: Object.keys(WILAYA_IDS),
    foundWilayaId: WILAYA_IDS[normalizedWilaya] || WILAYA_IDS[orderData.wilaya],
    originalCommune: orderData.commune,
    normalizedCommune: communeField,
  });
  
  console.log("๐ฆ ุงูุจูุงูุงุช ุงููุฑุณูุฉ ุฅูู ZR Express:", payload);

  const response = await fetch("https://procolis.com/api_v1/add_colis", {
    method: "POST",
    headers: {
      token: ZR_EXPRESS_CONFIG.token,
      key: ZR_EXPRESS_CONFIG.key,
      "Content-Type": "application/json",
      Accept: "application/json",
    },
    body: JSON.stringify(payload),
  });

  console.log("๐ฆ ุงุณุชุฌุงุจุฉ ZR Express:", {
    status: response.status,
    ok: response.ok,
  });

  if (!response.ok) {
    const errorText = await response.text();
    console.error("โ ุฎุทุฃ ูู ZR Express:", errorText);
    throw new Error(`ZR Express Error: ${response.status} - ${errorText}`);
  }

  const data = await response.json();
  console.log("โ ูุฌุญ ุฅูุดุงุก ุงูุทูุจ ูู ZR Express:", data);
  
  // ุงูุชุญูู ูู ูุฌูุฏ ุฃุฎุทุงุก ูู ุงูุงุณุชุฌุงุจุฉ
  if (data.Colis && data.Colis.length > 0) {
    const colis = data.Colis[0];
    if (colis.IDRetour !== "0" || colis.MessageRetour !== "Good") {
      console.error("โ ุฎุทุฃ ูู ZR Express:", {
        IDRetour: colis.IDRetour,
        MessageRetour: colis.MessageRetour,
        wilaya: colis.IDWilaya,
        commune: colis.Commune
      });
      
      // ุจุฏูุงู ูู ุฑูู ุฎุทุฃุ ูุนูุฏ ุงูุจูุงูุงุช ูุน ุฑุณุงูุฉ ุงูุฎุทุฃ
      return {
        success: false,
        error: colis.MessageRetour,
        errorId: colis.IDRetour,
        trackingNumber: trackingNumber,
        data: data
      };
    }
  }
  
  return data;
}

export async function createZRExpressOrderNew(orderData: {
  firstName: string
  lastName: string
  phone: string
  address: string
  wilaya: string
  commune: string
  deliveryType: "home" | "office"
  productName: string
  quantity: number
  price: number
  codAmount: number
  weight: number
  notes?: string
  source?: string
  referenceId?: string
}) {
  const response = await fetch("https://api.zr-express.com/orders", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${process.env.ZR_EXPRESS_TOKEN}`,
    },
    body: JSON.stringify({
      client: {
        first_name: orderData.firstName,
        last_name: orderData.lastName,
        phone: orderData.phone,
        address: orderData.address,
        wilaya: orderData.wilaya,
        commune: orderData.commune,
        "delivery-type": orderData.deliveryType,
      },
      order: {
        product_name: orderData.productName,
        quantity: orderData.quantity,
        price: orderData.price,
        cod_amount: orderData.codAmount,
        weight: orderData.weight,
        notes: orderData.notes || "",
      },
      metadata: {
        source: orderData.source || "nextweardz",
        reference_id: orderData.referenceId || "",
      }
    }),
  })

  const data = await response.json()
  return data
}
